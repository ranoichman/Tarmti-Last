<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>SB Admin 2 - Bootstrap Admin Theme</title>
    <!-- Bootstrap Core CSS -->
    <link href="../vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <!-- MetisMenu CSS -->
    <link href="../vendor/metisMenu/metisMenu.min.css" rel="stylesheet">
    <!-- Morris Charts CSS -->
    <link href="../vendor/morrisjs/morris.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="../dist/css/sb-admin-2.css" rel="stylesheet">
    <!-- Custom Fonts -->
    <link href="../vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
    <div id="wrapper">
        <div id="page-wrapper" style="margin: 0 0 0 0;">
            <div class="row">
                <div class="col-lg-12">
                    <h1 class="page-header"></h1>
                </div>
                <!-- /.col-lg-12 -->
            </div>
            <!-- /.row -->

            <div class="row">
                <!--צ'אט-->
                <div class="col-lg-5">

                    <div class="chat-panel panel panel-default">
                        <div class="panel-heading">
                            <i class="fa fa-comments fa-fw"></i> צ'אט
                        </div>
                        <!-- /.panel-heading -->
                        <div class="panel-body">
                            <ul id="chat" class="chat">
                                <li class="left clearfix">
                                    <span class="chat-img pull-left">
                                        <img src="http://placehold.it/50/55C1E7/fff" alt="User Avatar" class="img-circle" />
                                    </span>
                                    <div class="chat-body clearfix">
                                        <div class="header">
                                            <strong class="primary-font">הילי יעקבסון</strong>
                                            <small class="pull-right text-muted">
                                                <i class="fa fa-clock-o fa-fw"></i> שעתיים
                                            </small>
                                        </div>
                                        <p>
                                            חברים, האתר מתחיל לקבל צורה, נראה ממש טוב בואו ניתן פוש אחרון
                                        </p>
                                    </div>
                                </li>
                                <li class="right clearfix">
                                    <span class="chat-img pull-right">
                                        <img src="http://placehold.it/50/FA6F57/fff" alt="User Avatar" class="img-circle" />
                                    </span>
                                    <div class="chat-body clearfix">
                                        <div class="header">
                                            <small class=" text-muted">
                                                <i class="fa fa-clock-o fa-fw"></i> שעתיים
                                            </small>
                                            <strong class="pull-right primary-font">גולן הופרט</strong>
                                        </div>
                                        <p>
                                            מסכים, אני תכף מסיים לעבוד על דף הבית של אדמינים בקרוב מעלים לשרת ומתחילים בדיקות
                                        </p>
                                    </div>
                                </li>
                                <li class="right clearfix">
                                    <span class="chat-img pull-right">
                                        <img src="http://placehold.it/50/FA6F57/fff" alt="User Avatar" class="img-circle" />
                                    </span>
                                    <div class="chat-body clearfix">
                                        <div class="header">
                                            <small class=" text-muted">
                                                <i class="fa fa-clock-o fa-fw"></i> שעה
                                            </small>
                                            <strong class="pull-right primary-font">רן הויכמן</strong>
                                        </div>
                                        <p>
                                            כן נראה ממה טוב
                                        </p>
                                    </div>
                                </li>
                                <li class="right clearfix">
                                    <span class="chat-img pull-right">
                                        <img src="http://placehold.it/50/FA6F57/fff" alt="User Avatar" class="img-circle" />
                                    </span>
                                    <div class="chat-body clearfix">
                                        <div class="header">
                                            <small class=" text-muted">
                                                <i class="fa fa-clock-o fa-fw"></i> שעה
                                            </small>
                                            <strong class="pull-right primary-font">רן הויכמן</strong>
                                        </div>
                                        <p>
                                            התכוונתי נראה ממש טוב
                                        </p>
                                    </div>
                                </li>
                                <li class="left clearfix">
                                    <span class="chat-img pull-left">
                                        <img src="http://placehold.it/50/55C1E7/fff" alt="User Avatar" class="img-circle" />
                                    </span>
                                    <div class="chat-body clearfix">
                                        <div class="header">
                                            <strong class="primary-font">הילי יעקבסון</strong>
                                            <small class="pull-right text-muted">
                                                <i class="fa fa-clock-o fa-fw"></i> 12 דקות
                                            </small>
                                        </div>
                                        <p>
                                            יאללה אני סיימתי לעבוד על הדוחות, בואו נעלה לשרת
                                        </p>
                                    </div>
                                </li>

                            </ul>
                        </div>
                        <!-- /.panel-body -->
                        <div class="panel-footer">
                            <div class="input-group">
                                <input id="chatInput" type="text" class="form-control input-sm" placeholder="הקלד את הודעתך כאן..." />
                                <span class="input-group-btn">
                                    <button class="btn btn-warning btn-sm" id="btn-chat" onclick="addMsgToChat()">
                                        שלח
                                    </button>
                                </span>
                            </div>
                        </div>
                        <!-- /.panel-footer -->
                    </div>



                </div>

                <!--כמות משתמשים פעילים-->
                <div class="col-lg-7 homeInfo">
                    <div class="panel panel-primary">
                        <div class="panel-heading">
                            <div class="row">
                                <div class="col-xs-3">
                                    <i class="fa fa-users fa-5x pull-left"></i>
                                </div>
                                <div class="col-xs-9 text-right">
                                    <div class="huge" id="userAmount_Sum"></div>
                                    <div id="userAmount_Text">אין מידע לתצוגה</div>
                                </div>
                            </div>
                        </div>
                        <a href="manageUsers.html">
                            <div class="panel-footer">
                                <span class="pull-right">פרטים נוספים</span>
                                <span class="pull-left"><i class="fa fa-arrow-circle-left"></i></span>
                                <div class="clearfix"></div>
                            </div>
                        </a>
                    </div>
                </div>
                <!--כמות מכרזים פעילים-->
                <div class="col-lg-7 homeInfo">
                    <div class="panel panel-green">
                        <div class="panel-heading">
                            <div class="row">
                                <div class="col-xs-3">
                                    <i class="fa fa-shopping-cart fa-5x pull-left"></i>
                                </div>
                                <div class="col-xs-9 text-right">
                                    <div class="huge" id="auctionsAmount_Sum"></div>
                                    <div id="auctionsAmount_Text">אין מידע לתצוגה</div>
                                </div>
                            </div>
                        </div>
                        <a href="#">
                            <div class="panel-footer">
                                <span class="pull-right">פרטים נוספים</span>
                                <span class="pull-left"><i class="fa fa-arrow-circle-left"></i></span>
                                <div class="clearfix"></div>
                            </div>
                        </a>
                    </div>
                </div>
                <!--סכום תרומה בחודש האחרון-->
                <div class="col-lg-7 homeInfo">
                    <div class="panel panel-yellow">
                        <div class="panel-heading">
                            <div class="row">
                                <div class="col-xs-3">
                                    <i class="fa fa-money fa-5x pull-left"></i>
                                </div>
                                <div class="col-xs-9 text-right">
                                    <div class="huge" id="donationLM_amount"></div>
                                    <div id="donationLM_Text">אין מידע לתצוגה</div>
                                </div>
                            </div>
                        </div>
                        <a href="#">
                            <div class="panel-footer">
                                <span class="pull-right">פרטים נוספים</span>
                                <span class="pull-left"><i class="fa fa-arrow-circle-left"></i></span>
                                <div class="clearfix"></div>
                            </div>
                        </a>
                    </div>
                </div>
                <!--פרטים על עמותה אקראית-->
                <div class="col-lg-7 homeInfo">
                    <div class="panel panel-red">
                        <div class="panel-heading">
                            <div class="row">
                                <div class="col-xs-3">
                                    <i class="fa fa-empire fa-5x pull-left"></i>
                                </div>
                                <div class="col-xs-9 text-right">
                                    <div class="col-xs-1" id="refreshIcon">
                                        <i class="fa fa-refresh fa-2x clickable" onclick="refreshAmuta()"></i>
                                    </div>
                                    <div class="huge" id="randAmuta_Det"></div>

                                    <div id="randAmuta_Name">אין מידע לתצוגה</div>
                                </div>
                            </div>
                        </div>
                        <a href="#">
                            <div class="panel-footer">
                                <span class="pull-right">פרטים נוספים</span>
                                <span class="pull-left"><i class="fa fa-arrow-circle-left"></i></span>
                                <div class="clearfix"></div>
                            </div>
                        </a>
                    </div>
                </div>


            </div>
            <!-- /.row -->

        </div>
    </div>
    <!-- /.panel -->
    
   
    <!-- /#wrapper -->
    <!-- jQuery -->
    <script src="../vendor/jquery/jquery.min.js"></script>
    <!-- Bootstrap Core JavaScript -->
    <script src="../vendor/bootstrap/js/bootstrap.min.js"></script>
    <!-- Metis Menu Plugin JavaScript -->
    <script src="../vendor/metisMenu/metisMenu.min.js"></script>
    <!-- Morris Charts JavaScript -->
    <script src="../vendor/raphael/raphael.min.js"></script>
    <script src="../vendor/morrisjs/morris.min.js"></script>
    <script src="../data/morris-data.js"></script>
    <!-- Custom Theme JavaScript -->
    <script src="../dist/js/sb-admin-2.js"></script>
    <!-- Assoc class -->
    <script src="../js/classes/Assoc.js"></script>




    <script>



        $(document).ready(function () {

            if (window.self == window.top) {
                window.location = "ManagerMaster.html";
            }
            else {
                runAuctionsPromise();
                runUserPromise();
                runDonationsPromise();
                runAssocPromise();
            }


        })

        // הגדרת משתנים לדף
        var usersPromise = new Promise(function (resolve, reject) {
            $.ajax({
                dataType: "json",
                url: "/../AdminWebService.asmx/CountActiveUsers",
                contentType: "application/json; charset=utf-8",
                type: "POST",
                data: JSON.stringify({}),
                success: function (data) {
                    resolve(data.d);
                },
                error: function (err) {
                }
            });
        });

        var auctionsPromise = new Promise(function (resolve, reject) {

            $.ajax({
                dataType: "json",
                url: "/../AdminWebService.asmx/GetActiveAuctions",
                contentType: "application/json; charset=utf-8",
                type: "POST",
                data: JSON.stringify({}),
                success: function (data) {
                    resolve(data.d);
                },
                error: function (err) {
                }
            });
        });

        var donationsPromise = new Promise(function (resolve, reject) {

            $.ajax({
                dataType: "json",
                url: "/../AdminWebService.asmx/GetDonationsLastMonth",
                contentType: "application/json; charset=utf-8",
                type: "POST",
                data: JSON.stringify({}),
                success: function (data) {
                    resolve(data.d);
                },
                error: function (err) {
                }
            });
        });

        var assocPromise = new Promise(function (resolve, reject) {
            $.ajax({
                dataType: "json",
                url: "/../AssociationsWebService.asmx/GetAllAmotaDetails",
                contentType: "application/json; charset=utf-8",
                type: "POST",
                data: JSON.stringify({}),
                success: function (data) {
                    resolve(data.d);
                },
                error: function (err) {
                    return err;
                }
            });
        });

        var assocArr = new Array(); // יצירת מערך שמחזיק קוד עמותות לצורך בחירה אקראית

        var assocMap = new Map(); //יצירת מערך מסוג מפה שמחזיק פרטי עמותה


        //הגדרת פונקציות

        //הרצת פרומיס להבאת כמות משתמשים פעילים
        function runUserPromise() {
            usersPromise.then(function (usersData) {
                var count = usersData;
                $("#userAmount_Sum").text(count + " משתמשים פעילים");
                $("#userAmount_Text").text("");
            });
        }

        //הרצת פרומיס להבאת מכרזים פעילים
        function runAuctionsPromise() {
            auctionsPromise.then(function (aucData) {
                var auctionsArr = JSON.parse(aucData);
                var count = auctionsArr[0];
                var sum = auctionsArr[1];
                $("#auctionsAmount_Sum").text("כרגע " + count + " מכרזים פעילים");
                $("#auctionsAmount_Text").text("סכום תרומה של מכרזים פעילים: " + sum);
            });

        }

        //הרצת פרומיס להבאת סכום תרומות בחודש האחרון
        function runDonationsPromise() {
            donationsPromise.then(function (donationData) {
                var donationSum = donationData;
                $("#donationLM_amount").text(donationData + " ש\"ח נתרמו בחודש האחרון!");
                $("#donationLM_Text").text("");
            });

        }

        //הרצת פרומיס להבאת קודי עמותות
        function runAssocPromise() {
            assocPromise.then(function (assocData) {
                var assocCodes = JSON.parse(assocData);
                var j = 0;

                for (i in assocCodes) {
                    var tags = "";
                    //מילוי רשימת תגיות
                    for (let tag of assocCodes[i].Association_Tags)
                    {
                        tags += tag.Tag_Name + ", ";
                    }
                    tags = tags.slice(0, -2);
                    assocArr[j] = assocCodes[i].Association_Code;
                    assocMap.set(assocCodes[i].Association_Code, new assocMNG(assocCodes[i].Association_Code, assocCodes[i].Association_Name, tags));
                    j++;
                } // end for
            }).then(function (data) {  //סיום פרומיס ראשון וקריאה לאחד נוסף
                refreshAmuta();
            }); // סיום פרומיס שני
        }

        //פונקציה לשינוי המידע שמוצג בתיבת עמותה
        function refreshAmuta() {
            var rnd = Math.floor(Math.random() * assocArr.length);
            var amutaCode = assocArr[rnd];
            var assoc = assocMap.get(amutaCode);

            if (assoc.donations == 0) {
                $.ajax({
                    dataType: "json",
                    url: "/../AdminWebService.asmx/GetDonationSum",
                    contentType: "application/json; charset=utf-8",
                    type: "POST",
                    async: false,
                    data: JSON.stringify({ code: amutaCode }),
                    success: function (data) {
                        var amount = data.d;
                        assoc.setDonation(amount);
                        console.log(assoc.donations);
                        assocMap.set(amutaCode, assoc);
                    }, // success
                    error: function (err) {
                    }//error
                }); //ajax
            }//if

            $("#randAmuta_Det").text(assoc.donations + " ש\"ח נתרמו עד כה לעמותת " + assoc.name);
            $("#randAmuta_Name").text("");
        }


        function addMsgToChat() {
            var $li = $("<li>").addClass("left clearfix");
            var $img = $("<img>").attr({ "src": "http://placehold.it/50/55C1E7/fff", "class": "img-circle" })
            var $span = $("<span>").addClass("chat-img pull-left");
            $span.append($img);
            $div = $("<div>").addClass("chat-body clearfix");
            $header = $("<div>").addClass("header");
            $strong = $("<strong>").addClass("primary-font").text("הילי יעקבסון");
            $small = $("<small>").addClass("pull-right text-muted");
            $i = $("<i>").addClass("fa fa-clock-o fa-fw");
            var small = "<small class='pull-right text-muted'><i class='fa fa-clock-o fa-fw'></i> 12 דקות</small>"
            $header.append($strong, small);
            var x = $("#chatInput").text();
            $p = $("<p>").text($("#chatInput").val());
            $div.append($header, $p);
            $li.append($span, $div);
            $("#chat").append($li);


        }




    </script>

</body>
</html>
